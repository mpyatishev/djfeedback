{% load staticfiles %}
{% load compress %}
{% block css %}
    {% compress css %}
        <link href="{% static 'built/dj-feedback.css' %}" rel="stylesheet" />
    {% endcompress %}
{% endblock %}

<div class="b-dj-feedback">
    <span class="b-toggler _name_dj-feedback b-toggler__toggler">
        <span class="b-toggler__text">Feedback</span>
    </span>

    <div class="b-toggler _name_dj-feedback b-toggler__panel">
        <form class="b-dj-feedback__form" action="" method="POST">
            <fieldset>
                {% csrf_token %}
                {{ feedback_form }}
                <button type="submit">Submit</button>
            </fieldset>
        </form>
    </div>
</div>

<script src="{% static 'vendor/requirejs/require.js' %}"></script>
<script>
require(['{% static 'js/common.js' %}'], function () {
    require([
        'jquery',
        'jqueryCookie',
        'toggler',
    ], function (
        $,
        _jqueryCookie,
        Toggler
    ) {
        var toggler = new Toggler({
            name: 'dj-feedback',
        });

        function csrfSafeMethod(method) {
            // these HTTP methods do not require CSRF protection
            return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
        }

        $('document').ready(function() {
            var form = $('form');
            form.submit(function(event) {
                event.preventDefault();
                var data = new FormData(form[0]);
                $.ajax({
                    url: "{% url 'feedback-post' %}",
                    type: 'POST',
                    data: data,
                    processData: false,
                    contentType: false,
                    beforeSend: function(xhr, settings) {
                        if (!csrfSafeMethod(settings.type)) {
                            xhr.setRequestHeader('X-CSRFToken', $.cookie('csrftoken'));
                        }
                    },
                    success: function(data, textStatus, jqXHR) {
                        console.log(data);
                    },
                    error: function(jqXHR, textStatus, error) {
                        console.log(error);
                    }
                });
            });
        });
    });
});
</script>
